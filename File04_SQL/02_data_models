-- Table dimension Pays
CREATE OR REPLACE TABLE `uk-retail-europe.mart.dim_geography` AS
SELECT DISTINCT
  Country,
  CASE 
    WHEN Country IN ('France', 'Belgium', 'Switzerland') THEN 'Francophone'
    WHEN Country = 'United Kingdom' THEN 'UK'
    WHEN Country IN ('Germany', 'Spain', 'Italy', 'Netherlands', 'Portugal') THEN 'Europe West'
    ELSE 'Other'
  END AS Region
FROM `uk-retail-europe.clean.online_retail`
WHERE Country IS NOT NULL;



-- Table dimension Clients
CREATE OR REPLACE TABLE `uk-retail-europe.mart.dim_customers` AS
SELECT 
  CustomerID,
  Country,
  MIN(InvoiceDate) AS FirstPurchaseDate,
  MAX(InvoiceDate) AS LastPurchaseDate,
  COUNT(DISTINCT InvoiceNo) AS TotalOrders,
  SUM(TotalAmount) AS TotalRevenue
FROM `uk-retail-europe.clean.online_retail`
WHERE CustomerID IS NOT NULL
GROUP BY CustomerID, Country;



-- Table dimension Produits
CREATE OR REPLACE TABLE `uk-retail-europe.mart.dim_products` AS
SELECT 
  StockCode,
  Description,
  AVG(UnitPrice) AS AvgPrice,
  COUNT(DISTINCT InvoiceNo) AS TimesOrdered
FROM `uk-retail-europe.clean.online_retail`
WHERE StockCode IS NOT NULL
GROUP BY StockCode, Description;



-- Table de faits - Commandes
CREATE OR REPLACE TABLE `uk-retail-europe.mart.fact_orders` AS
SELECT 
  InvoiceNo,
  InvoiceDate,
  CustomerID,
  StockCode,
  Country,
  Quantity,
  UnitPrice,
  TotalAmount,
  IsReturn,
  IsB2B,
  EXTRACT(YEAR FROM InvoiceDate) AS Year,
  EXTRACT(MONTH FROM InvoiceDate) AS Month,
  FORMAT_TIMESTAMP('%Y-%m', InvoiceDate) AS YearMonth
FROM `uk-retail-europe.clean.online_retail`;



-- =============================================================================
-- FACT TABLE: Orders
-- =============================================================================
-- Description: Main fact table containing all transaction-level order data
-- Source: clean.online_retail
-- Grain: One row per order line (InvoiceNo + StockCode)
-- 
-- Usage:
--   - Dashboard 1: Executive Overview (line chart, map, KPIs)
--   - Time series analysis
--   - Geographic distribution
-- 
-- Filters applied:
--   - None (all transactions included, use IsReturn/IsB2B flags to filter)
-- =============================================================================

CREATE OR REPLACE VIEW `uk-retail-europe.mart.fact_orders` AS
SELECT 
  InvoiceNo,
  InvoiceDate,
  StockCode,
  Description,
  Quantity,
  UnitPrice,
  CustomerID,
  Country,
  TotalAmount,
  IsReturn,
  IsB2B,
  EXTRACT(YEAR FROM InvoiceDate) as Year,
  EXTRACT(MONTH FROM InvoiceDate) as Month,
  FORMAT_TIMESTAMP('%Y-%m', InvoiceDate) as YearMonth
FROM `uk-retail-europe.clean.online_retail`;
