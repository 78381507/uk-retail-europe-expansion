-- ================================================
-- DATA CLEANING - Online Retail Dataset
-- ================================================
-- Objectif: Créer clean.online_retail avec données validées

CREATE OR REPLACE TABLE `uk-retail-europe.clean.online_retail` AS
SELECT 
  -- Colonnes de base
  InvoiceNo,
  StockCode,
  COALESCE(Description, 'Unknown Product') AS Description,
  Quantity,
  
  -- Conversion date en TIMESTAMP
  PARSE_TIMESTAMP('%m/%d/%Y %H:%M', InvoiceDate) AS InvoiceDate,
  
  UnitPrice,
  CustomerID,
  Country,
  
  -- Colonnes calculées
  Quantity * UnitPrice AS TotalAmount,
  
  -- Flag pour identifier les retours
  CASE 
    WHEN Quantity < 0 THEN TRUE 
    ELSE FALSE 
  END AS IsReturn,
  
  -- Flag pour identifier les transactions B2B (sans CustomerID)
  CASE 
    WHEN CustomerID IS NULL THEN TRUE 
    ELSE FALSE 
  END AS IsB2B

FROM `uk-retail-europe.raw.online_retail`

WHERE 
  -- On garde seulement les lignes valides
  InvoiceNo IS NOT NULL
  AND UnitPrice > 0
  AND Quantity != 0;  -- On garde les retours mais pas les quantités à 0
